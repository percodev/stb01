Логика формирования событий такая:
1. Изменение состояния контроллера - событие формируется.
2. Далее оно сохраняется в БД.
3. После сохранения оно пересылается по всем открытым сокетам, если соответствует условиям фильтрации, в виде: 

```json
{"event":{"id":40140,"date":1629967880,"timezone_offset":-10800,"code":4,"category":1, "number":0}}
```

Событие будет передано по конкретному сокету, если установлен фильтр вида:

```json
{"set":"event_acl","event_acl":[{"code":1,"allow":true},{"code":4,"allow":true},{"allow":false}]}
```

(Здесь фильтр установлен на приём событий с кодами 1 и 4, остальные пересылаться не будут).

Т.е. сторонний софт после открытия соединения и авторизации, если хочет принимать определённые события асинхронно (без запроса, в момент их формирования), должен передать кадр 
"set":"event_acl". Для приёма всего, без разбора, следующий кадр - 

```json
{"set": "event_acl", "event_acl": [{"allow":"true"}]}
```

Вариант работы по событиям:
1. Подключение.
2. Авторизация. (попытка установки фильтра п.3 -> требование авторизации -> авторизация)
3. Установка фильтра.
4. Запрос событий, и сохранение их в собственной БД.
5. Запрос состояния.
6. Далее, любое изменение состояния контроллера будет сопровождаться формированием (соответствующего этому изменению) события. Контроллер передаёт это событие асинхронно.

Пример пп. 2,3,6:

софт -> 
```json
{"set": "event_acl", "event_acl": [{"allow": "true"}]}
```

контроллер -> 
```json
{"event":"need_auth","need_auth":{"salt":"qewarvhn"}}
```

софт -> 
```json
{"set":"auth","auth":{"hash":"65ccf195f4983bb4951bbf38f58da071"}}
```

контроллер -> 
```json
{"answer":{"auth":"ok","set":"own"},"auth":{"hash":"65ccf195f4983bb4951bbf38f58da071"}}
```

софт -> // Вот здесь повтор запроса после успешной авторизации!
```json
{"set": "event_acl", "event_acl": [{"allow": "true"}]}
```

контроллер -> 
```json
{"answer":{"event_acl":"ok","set":"own"},"event_acl":[{"allow":"true"}]}
```

.....

```json
{"event":{"id":151449,"date":1744284422,"code":103,"category":1,"number":1}}
```


# Установка фильтра принимаемых событий.
## Установка:

События формируемые контроллером могут передаваться асинхронно, в момент формирования (в дополнение к получению событий по запросу). Для получения асинхронных событий надо настроить фильтры `event_acl`.
Внутри фильтра все поля объединяются по «И», фильтры объединяются по «ИЛИ».
Параметры фильтра совпадают с полями событий. Событие перед отправкой проходит через все фильтры до того, который его пропускает.

```json
{
	"set": "event_acl",
	"event_acl": [	
            {
                "allow":"true",
                "category":"0",
                "number":"1",
            },
            {
                "allow":"false"
            }
	]
}
```
## Ответ:
```json
{
    "answer":{"event_acl":"ok","set":"own"},
    "event_acl": [	
        {
            "allow":"true",
            "category":"0",
            "number":"1",
        },
        {
            "allow":"false"
        }
    ]
}
```
# Количество событий.
## Запрос:
```json
{
    "get":"event_count"
}
```

## Ответ:
```json
{
    "answer":{"event_count":"ok"},
    "event_count":{"value":150001}
}
```  

# Получение событий.
## Запрос:
```json
{
    "get":"event",
    "event" : {
        "limit":1,
        "offset":0,
        "category":["0","1","2","3","4","5"],
        "code":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16],
        "start":-10800,
        "stop":2082747540
    }
}
```
## Ответ:
```json
{
    "answer":{"event":"ok"},
    "event":{
        "id":40140,
        "date":1629967880,
        "timezone_offset":-10800,
        "code":102,
        "category":1,
        "number":0
    }
}

{
    "answer":{"event":"ok"},
    "event":{
        "id":40140,
        "date":1629967880,
        "timezone_offset":-10800,
        "code":4,
        "category":1,
        "number":0
    }
}
```

# Удаление событий.
## Запрос:
```json
{
    "control":"event",
    "event" : {}
}
```
## Ответ:
```json
{
    "result":{"event":"ok"},
    "event":{ }
}
```
`allow` — Пропуск события через фильтр
		`true` - да
		`false` - нет 

`limit` — Ограничение событий в выборке 1 — 20

`offset` — Сдвиг выборки событий относительно 1-го (самого позднего)  события 0 — 4294967295

`start`/`stop` — Начало/конец диапазона в сек от 01.01.1970 (включительно)

`start_id`/`stop_id` — Начало/конец диапазона по id событий  (включительно)

`done` — Необязательный параметр запроса. Признак окончания передачи событий в ответ на запрос. Если в запросе выставлен в `true`, то после последнего переданного контроллером события будет дополнительны кадр с объектом {`done`:`true`}.

`date` — Дата в секундах с 1970 г по 2038 г(точность до 1 секунды)

`timezone_offset` — Сдвиг временной зоны относительно UTC в с. на момент формирования события (точность до 1 секунды) (Значение -10800, например, соответствует временной зоне GMT+3)

`category` — Категория : 0 — 4
	
	`0` - События, связанные с функционированием
	`1` - События, связанные с неисправностями и восстановлениями
	`2` - События, связанные с неперсонифицированным доступом
	`3` - События, связанные с состояниями входов / выходов
	`4` - События, связанные с сервисными функциями и диагностикой уст-ва


`code` — Код события  :  0 — ?
	
`number` — Номер ресурса : 0 — ?


# Коды событий


Категория `0` - События, связанные с функционированием


0x10	Включение питания контроллера

0x11	Выключение питания контроллера

0x12	Перезапуск контроллера

0x13	Перезапуск приложения ("горячий" старт)

0x14	Неисправность ИП

0x15	Восстановление ИП

0x16	Корпус контроллера открыт

0x17	Корпус контроллера закрыт


Категория `1` - События, связанные с неисправностями и восстановлениями


0x30	Восстановление связи с платой MAIN

0x32	Нарушение связи с платой MAIN

0x33	Восстановление связи с платой IR_LED

0x34	Нарушение связи с платой IR_LED

0x35	Восстановление связи с платой мотора

0x36	Нарушение связи с платой мотора

0x40	Ошибка инициализации датчиков (перекрытие по старту)

0x41	Восстановление датчиков (перекрытых по старту)

0x42	Ошибка платы датчиков

0x43	Восстановление платы датчиков

0x44	Ошибка платы мотора

0x45	Восстановление платы мотора


Категория `2` - События, связанные с неперсонифицированным доступом

0x80	Проход по команде от ДУ

0x81	Проход по команде от оператора ПК

0x82	Проход по команде ИК-пульта

0x83	Несанкционированный проход через ИУ (взлом ИУ)

0x84	ИУ не закрыто после прохода по команде от ДУ

0x85	ИУ не закрыто после прохода по команде от оператора ПК

0x86	ИУ разблокирован

0x87	ИУ заблокирован


Категория `3` - События, связанные с состояниями входов / выходов

0xA0	Активизация входа

0xA1	Нормализация входа

0xA2	Активизация выхода

0xA3	Нормализация выхода

0xA4	Активизация входа FireAlarm

0xA5	Нормализация входа FireAlarm


Категория `4` - События, связанные с сервисными функциями и диагностикой уст-ва

0x60	Динамическое создание новой БД (файл старой БД, а также резервная копия повреждны или отсутствуют)

0x61	Восстановление БД из резервной копии

0x62	Создание резервной копии БД

0x63	Создание копии БД

0x64	Создание копии БД не удачно

0x65	Очистка событий журнала регистрации



