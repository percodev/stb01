## Сокет
Прикладной протокол обмена поверх WebSockets (RFC 6455). Контроллер подключается по ip-адресу сервера системы, заданному при конфигурации. Возможно использование защищеного канала WSS (WebSockets over SSL/TLS).

Далее по тексту, под сервером понимается некий "сервер системы" - ПО верхнего уровня. До тех пор, пока контроллеру не будет задан IP-адрес этого сервера, подключение инициировать должен сам сервер (либо работа через WEB-браузер (с поддержкой WebSockets)). После задания IP-адреса сервера (либо через браузер, либо непосредственно самим сервером), контроллер будет подключаться к серверу сам.

При подключении к контроллеру в поле target запроса необходимо добавить '/tcp' (пример формирования сокета на JS 'ws://10.1.89.181:80/tcp'). Установка соединения по HTTP (для HTTPS аналогично) будет выглядеть так:

```http
GET /tcp HTTP/1.1
Host: 10.0.150.136
Origin: 10.0.150.136
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: 0M//4Wm9N3ngPpr7q6O3FQ==
Sec-WebSocket-Version: 13
Sec-WebSocket-Extensions: permessage-deflate; client_max_window_bits
User-Agent: Python/3.10 websockets/10.3
```
```http
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Sec-WebSocket-Accept: gt5pkLN0d02eA+OSekZqAZvRrFc=
Connection: upgrade
Date: Tue, 09 Jul 2024 12:45:32 GMT
Server: lighttpd/1.4.69
```

## Протокол
Протокол использует формат обмена данных JSON (RFC 7159). Протокол оперирует объектами такими,  как "исполнительное устройство" и т.п. посредством следующих методов:

`get` — запрос сервером данных объекта;

`set` — запись сервером данных объекта (в энергонезависимую память);

`control` — управление объектом;

`answer` — ответ серверу `get`, `set`, `control`.

`event` — асинхронная передача данных серверу.

### Структура кадров
Запрос может содержать дополнительные параметры (необязательные), расширяющие ответ устройства.
```json
{
    "get" : "object",
    "object" : {
        "parametr_request_1" : 0,
        "parametr_request_1" : "any_string",
        "parametr_request_3" : false
    }
}
```
Установка параметров конфигурации объекта. Параметры сразу применяются и сохраняются в энергонезависимой памяти.
```json
{
    "set" : "object",
    "object" : {
        "parametr_object_1" : 0,
        "parametr_object_2" : "card",
        "parametr_object_3" : false,
        "parametr_object_4" : 268435455
    }
}
```
Управление объектом (не все объекты поддерживают команды управления).
```json
{
	"control":"object",
	"object":{
		"action":"open_once",
		"time":10,
		"number":0, 
		"direction":0
	}
}
```
Ответ ведущему устройству на команды `get` и `set` содержит параметры объекта, сохранённые в энергонезависимой памяти.
```json
{
	"answer":{"object":"ok"},
	"object":{
		"parametr_object_1" : 0,
        	"parametr_object_2" : "card",
        	"parametr_object_3" : false,
       		"parametr_object_4" : 268435455
	}
}
```
Ответ ведущему устройству на команду `control` содержит параметры запроса.
```json
{
	"answer":{"object":"ok"},
	"object":{
		"action":"open_once",
		"time":10,
		"number":0, 
		"direction":0
	}
}
```
Асинхронное событие от устройства.
```json
{
	"event":"object",
	"object":{
		"parametr_event_1" : 0,
        	"parametr_event_2" : "open",
        	"parametr_event_3" : true,
       		"parametr_event_4" : 268435455
	}
}
```


### [1) Авторизация](https://git.perco.ru/das/stb01/-/wikis/%D0%90%D0%B2%D1%82%D0%BE%D1%80%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F)